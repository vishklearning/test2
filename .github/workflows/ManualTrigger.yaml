name: Manual Trigger Workflow

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment for deployment'
        required: true
        default: 'production'
      repository1:
        description: 'Global Repository'
        required: true
      repository2:
        description: 'Regional Repository'
        required: true
      reference:
        description: 'Version To Deploy Global REpository'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: "18"
      - name: Install SFDX CLI
        run: npm install sfdx-cli --global
        
      # install SFDX Scanner
      - name: Install SFDX-Scanner
        run:  sfdx plugins:install @salesforce/sfdx-scanner
      
      - name: Checkout Python_Scripts
        uses: actions/checkout@v3
        with:
          repository: vishklearning/Python_Scripts          
          path: ./acct-scripts
        
      # Checkout the first repository
      - name: Checkout Repository 1
        uses: actions/checkout@v2
        with:
          repository: vishklearning/test2
          path: ./force-app1
          ref: main

      # Checkout the second repository
      - name: Checkout Repository 2
        uses: actions/checkout@v2
        with:
          repository: vishklearning/Demo-SF-GH
          path: ./force-app2
          ref: master

#      # Run the MergeDX
#       - name: MergerDX
#         id: MergerDX
#         continue-on-error: true
#         run: |
#           python3 ./acct-scripts/mergerDX/merger.py merge_delta -s ${{github.head_ref}} -t ${{github.base_ref}} -a ${{secrets.API_VERSION}}
#           if [ $? -eq 0 ] && [ $(ls srcToDeploy | wc -l) -ne 0 ]; then
#             echo "Success in MergeDX"
#             zip -r srcToDeploy.zip ./srcToDeploy/
#             git rev-parse --verify HEAD
#           else 
#             echo "::warning:: Failure in MergeDX: The srcToDeploy.zip is EMPTY(i.e. No New Code Changes Detected)"
#             exit 1
#           fi
      
      - name: Merge Repository 1
        run: |
          cp -r ./force-app1  ./force-app2 ./forceapp

      # Authenticate to Salesforce using JWT-based authentication
      - name: Authenticate to Salesforce
        run: |
          sfdx auth:jwt:grant --username vishksalesforce@gmail.com.dev1 -f ./assests/server.key -i 3MVG9OjW2TAjFKUvMO.2ZqzAwK6pcsQgJU4Fj45jsD6_FWjV2uwH4cPcG0pOIkYxCxS0jl25186Se.tkjCcbW -r https://computing-efficiency-483.scratch.my.salesforce.com -a huborg

      # Deploy the merged metadata to Salesforce
      - name: Deploy to Salesforce
        run: |
          sfdx force:source:deploy -p force-app -u huborg
